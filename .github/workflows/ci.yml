name: FastAPI Testing CI

# ë©”ì¸ ë¸Œëœì¹˜ì— ì½”ë“œê°€ push ë˜ê±°ë‚˜ PRì´ ìƒì„±ë  ë•Œ ì‹¤í–‰
on:
  push:
    branches: [ "main", "test/sonar" ]  # ë‚´ ë¸Œëœì¹˜ì— Pushí•  ë•Œë„ ì•¡ì…˜ì´ ëŒê²Œ í•˜ë ¤ë©´ ì¶”ê°€!
  pull_request:
    branches: [ "main" ]                # mainìœ¼ë¡œ í•©ì³ë‹¬ë¼ëŠ” PRì´ ì—´ë¦´ ë•Œ ì‘ë™!
    
jobs:
  test:
    runs-on: ubuntu-latest
    
    # ë´‡(Bot)ì´ PRì— ì»¤ë²„ë¦¬ì§€ ëŒ“ê¸€ì„ ë‹¬ ìˆ˜ ìˆë„ë¡ ì“°ê¸° ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
    permissions:
      pull-requests: write
      contents: write

    steps:
    - name: 1. ë‚´ ì½”ë“œ ë³µì‚¬í•´ì˜¤ê¸°
      uses: actions/checkout@v3
      with:
        # SonarCloudê°€ ìƒˆ ì½”ë“œì™€ ì˜›ë‚  ì½”ë“œë¥¼ ë¹„êµí•  ìˆ˜ ìˆë„ë¡ ëª¨ë“  ê¹ƒ ê¸°ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. (ë§¤ì£¼ ì¤‘ìš”!)
        fetch-depth: 0  

    - name: 2. íŒŒì´ì¬ 3.10 í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: 3. í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_unittest.txt

    - name: 4. Pytest ì‹¤í–‰ ë° 2ê°€ì§€ ì»¤ë²„ë¦¬ì§€ íŒŒì¼(xml, txt) ë™ì‹œ ìƒì„±
      run: |
        # --cov-report=xml ì€ 'coverage.xml' íŒŒì¼ì„ ì¡°ìš©íˆ ë§Œë“­ë‹ˆë‹¤.
        # --cov-report=term ì€ ê²°ê³¼ë¥¼ í„°ë¯¸ë„ì— ì¶œë ¥í•˜ëŠ”ë°, ê·¸ê±¸ '>' ê¸°í˜¸ë¡œ txtì— ì €ì¥í•©ë‹ˆë‹¤.
        pytest --cov=app --cov-report=xml --cov-report=term > pytest-coverage.txt

    - name: 5. ê¹ƒí—ˆë¸Œ í™”ë©´ì— ê°„ë‹¨í•œ ì»¤ë²„ë¦¬ì§€ í‘œ ë„ìš°ê¸° (MishaKav ë´‡)
      uses: MishaKav/pytest-coverage-comment@main
      with:
        # ì´ ë´‡ì—ê²ŒëŠ” txt íŒŒì¼ì„ ë¨¹ì—¬ì¤ë‹ˆë‹¤!
        pytest-coverage-path: ./pytest-coverage.txt
        title: "âœ… í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸"

    - name: 6. SonarCloud ì •ì  ì½”ë“œ ë¶„ì„
    # ğŸ’¡ ê¸°ì¡´ sonarcloud-github-action ëŒ€ì‹  ìµœì‹  ë²„ì „ì¸ sonarqube-scan-actionìœ¼ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.
      uses: SonarSource/sonarqube-scan-action@v5.0.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        # í•µì‹¬! ì†Œë‚˜í´ë¼ìš°ë“œì—ê²ŒëŠ” ë°˜ë“œì‹œ xml íŒŒì¼ì„ ë¨¹ì—¬ì¤ë‹ˆë‹¤!
        args: >
          -Dsonar.projectKey=dlaskgus93_fastapi-demo
          -Dsonar.organization=dlaskgus93
          -Dsonar.python.coverage.reportPaths=coverage.xml
          -Dsonar.sources=app/

    - name: 7. Push ì»¤ë°‹ì— SonarCloud ê²°ê³¼ URL ëŒ“ê¸€ ë‹¬ê¸°
      # ğŸ’¡ PRì´ ì•„ë‹Œ 'push' ì´ë²¤íŠ¸ì¼ ë•Œë§Œ ì´ ìŠ¤í…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
      if: github.event_name == 'push'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 1. ì†Œë‚˜í´ë¼ìš°ë“œ ì˜ìˆ˜ì¦ íŒŒì¼ì—ì„œ dashboardUrl ê°’ë§Œ ì¶”ì¶œí•©ë‹ˆë‹¤.
        SONAR_URL=$(grep dashboardUrl .scannerwork/report-task.txt | cut -d'=' -f2)
        
        # 2. ê¹ƒí—ˆë¸Œ APIë¥¼ ì´ìš©í•´ ë‚´ê°€ ë°©ê¸ˆ Pushí•œ ì»¤ë°‹ì— ê°•ì œë¡œ ëŒ“ê¸€ì„ ë‹µë‹ˆë‹¤.
        gh api \
          --method POST \
          -H "Accept: application/vnd.github+json" \
          /repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
          -f body="ğŸ” **SonarCloud ì •ì  ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!**
          ğŸ‘‰ ìƒì„¸ ê²°ê³¼ í™•ì¸í•˜ê¸°: $SONAR_URL"