name: FastAPI Testing CI

# 메인 브랜치에 코드가 push 되거나 PR이 생성될 때 실행
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    # 봇(Bot)이 PR에 커버리지 댓글을 달 수 있도록 쓰기 권한을 부여합니다.
    permissions:
      pull-requests: write
      contents: read

    steps:
    - name: 내 코드 복사해오기 (Checkout)
      uses: actions/checkout@v3

    - name: 파이썬 환경 설정
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: 필요한 패키지 설치
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Pytest로 테스트 실행 및 커버리지 파일 생성
      run: |
        # xml이 아니라 터미널 출력 결과를 txt 파일로 저장하도록 수정합니다.
        pytest --cov=app --cov-report=term > pytest-coverage.txt

    - name: 커버리지 결과를 PR 댓글과 Summary 화면에 보여주기
      uses: MishaKav/pytest-coverage-comment@main
      with:
        # 방금 만든 txt 파일을 읽으라고 경로를 수정해 줍니다.
        pytest-coverage-path: ./pytest-coverage.txt
        title: "✅ 테스트 커버리지 리포트"
        badge-title: "Coverage"